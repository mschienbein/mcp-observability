{
  "commands": [
    "set -euxo pipefail",
    "dnf -y install docker curl || yum -y install docker curl",
    "systemctl enable --now docker || systemctl start docker || true",
    "usermod -aG docker ec2-user || true",
    "mkdir -p /etc/clickhouse-server/config.d /etc/clickhouse-server/users.d /var/lib/clickhouse",
    "cat >/etc/clickhouse-server/config.d/listen.xml <<'EOF'\n<clickhouse>\n  <listen_host>0.0.0.0</listen_host>\n  <listen_host>::</listen_host>\n</clickhouse>\nEOF",
    "cat >/etc/clickhouse-server/config.d/ports.xml <<'EOF'\n<clickhouse>\n  <http_port>8123</http_port>\n  <tcp_port>9000</tcp_port>\n</clickhouse>\nEOF",
    "cat >/etc/clickhouse-server/users.d/default-user.xml <<'EOF'\n<clickhouse>\n  <users>\n    <default>\n      <password>langfuse</password>\n      <profile>default</profile>\n      <networks>\n        <ip>::/0</ip>\n      </networks>\n    </default>\n  </users>\n</clickhouse>\nEOF",
    "docker rm -f clickhouse || true",
    "docker run -d --name clickhouse --restart unless-stopped -p 8123:8123 -p 9000:9000 \\
      -v /var/lib/clickhouse:/var/lib/clickhouse \\
      -v /etc/clickhouse-server/config.d:/etc/clickhouse-server/config.d \\
      -v /etc/clickhouse-server/users.d:/etc/clickhouse-server/users.d \\
      clickhouse/clickhouse-server:latest",
    "for i in $(seq 1 24); do if curl -fsS http://127.0.0.1:8123/ping >/dev/null; then echo 'ClickHouse up (docker)'; break; else echo 'Waiting for ClickHouse (docker)...'; sleep 5; fi; done"
  ]
}
